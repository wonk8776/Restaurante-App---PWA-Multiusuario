<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familia González — Mesero</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1A3A6B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fam. González">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --color-bg: #F4F6FB;
            --color-card: #FFFFFF;
            --color-card-alt: #F0F4FF;
            --color-sidebar: #1A3A6B;
            --color-sidebar-active: #1565C0;
            --color-sidebar-text: #FFFFFF;
            --color-sidebar-text-muted: rgba(255,255,255,0.65);
            --color-primary: #1565C0;
            --color-primary-light: #E3EEFF;
            --color-primary-hover: #0D47A1;
            --color-accent: #1976D2;
            --color-green: #2E7D32;
            --color-green-light: #E8F5E9;
            --color-green-action: #388E3C;
            --color-green-action-hover: #2E7D32;
            --color-red: #C62828;
            --color-red-light: #FFEBEE;
            --color-warning: #F57F17;
            --color-warning-light: #FFF8E1;
            --color-text: #1A2744;
            --color-text-muted: #546E7A;
            --color-text-dim: #90A4AE;
            --color-border: #D6E0F0;
            --color-border-focus: #1565C0;
            --shadow-xs: 0 1px 3px rgba(26,58,107,0.08);
            --shadow-sm: 0 2px 8px rgba(26,58,107,0.10);
            --shadow-md: 0 4px 16px rgba(26,58,107,0.12);
            --shadow-lg: 0 8px 32px rgba(26,58,107,0.16);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-pill: 999px;
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Lato', sans-serif;
            --color-error: var(--color-red);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: var(--radius-pill);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary);
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        /* Header */
        header {
            background: var(--color-sidebar);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            border-bottom: none;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            color: #FFFFFF;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .waiter-name {
            font-size: 0.95rem;
            color: var(--color-sidebar-text-muted);
        }

        .waiter-name strong {
            color: #FFFFFF;
        }

        .btn-logout {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: var(--color-primary);
            color: #FFFFFF;
            box-shadow: var(--shadow-sm);
        }

        /* Main */
        main {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        h2 {
            font-family: var(--font-heading);
            font-size: 1.25rem;
            color: var(--color-text);
            margin-bottom: 1rem;
            letter-spacing: 0.5px;
        }

        /* Grid de mesas */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
        }

        @media (min-width: 769px) {
            .tables-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 1rem;
            }
        }

        .table-btn {
            padding: 1rem 0.5rem;
            background: var(--color-card);
            color: var(--color-text);
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 60px;
            min-width: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

        .table-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
            background: var(--color-primary-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .table-btn.selected {
            background: var(--color-primary-light);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .table-btn.mesa-propia {
            border-color: #2E7D32 !important;
            background: #E8F5E9 !important;
            color: #2E7D32 !important;
        }
        .table-btn.mesa-propia::after {
            content: ' ●';
            font-size: 0.55rem;
            vertical-align: super;
            color: #2E7D32;
        }
        .table-btn.mesa-ocupada-otro {
            border-color: #1565C0 !important;
            background: #E3EEFF !important;
            color: #1565C0 !important;
        }
        .table-btn.mesa-ocupada-otro::after {
            content: ' ●';
            font-size: 0.55rem;
            vertical-align: super;
            color: #1565C0;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 768px) {
            .modal-overlay {
                padding: 0;
                align-items: stretch;
                justify-content: stretch;
            }

            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                max-width: none;
                max-height: none;
                border-radius: 0;
                border: none;
                display: flex;
                flex-direction: column;
            }

            .modal-header {
                flex-shrink: 0;
                padding: 1rem 1.25rem;
            }

            .modal-title {
                font-size: 1.25rem;
            }

            .modal-close {
                font-size: 1.75rem;
                min-width: 44px;
                min-height: 44px;
                padding: 0.5rem;
            }

            .modal-body {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 1rem 1.25rem;
                display: flex;
                flex-direction: column;
            }

            .order-summary {
                display: flex;
                flex-direction: column;
                margin-top: auto;
            }

            .btn-send {
                flex-shrink: 0;
                width: 100%;
                min-height: 50px;
                margin-top: 1rem;
                position: sticky;
                bottom: 0;
            }

            .btn-add {
                width: 44px;
                height: 44px;
                min-width: 44px;
                min-height: 44px;
            }

            .tables-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.75rem;
            }

            .table-btn {
                min-height: 60px;
                text-align: center;
            }
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-card-alt);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: var(--font-heading);
            font-size: 1.35rem;
            color: var(--color-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 0.25rem;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--color-red);
        }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
            flex: 1;
        }

        /* Menú */
        .menu-section h3 {
            font-size: 0.75rem;
            color: var(--color-primary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 0.5rem;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            min-height: 60px;
            transition: all 0.2s;
        }

        .menu-item:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
            box-shadow: var(--shadow-xs);
        }

        .menu-item-info {
            flex: 1;
            min-width: 0;
        }

        .menu-item-name {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--color-text);
        }

        .menu-item-price {
            font-size: 0.85rem;
            color: var(--color-green-action);
            font-weight: 700;
        }

        .btn-add {
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            border-radius: 50%;
            background: var(--color-green-action);
            color: #FFFFFF;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.3s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .btn-add:hover {
            background: var(--color-green-action-hover);
            transform: scale(1.08);
        }

        /* Resumen pedido */
        .order-summary {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }

        .order-summary h3 {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.75rem;
        }

        .order-items {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            font-size: 0.9rem;
        }

        .order-item-qty {
            color: var(--color-primary);
            font-weight: 700;
            min-width: 2rem;
        }

        .order-total {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--color-primary);
            display: flex;
            justify-content: space-between;
            padding-top: 0.5rem;
        }

        .empty-order {
            color: var(--color-text-muted);
            font-size: 0.9rem;
            font-style: italic;
            padding: 0.5rem 0;
        }

        .btn-send {
            width: 100%;
            padding: 14px;
            background: var(--color-green-action);
            color: #FFFFFF;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 1rem;
            transition: background 0.3s, transform 0.1s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .btn-send:hover {
            background: var(--color-green-action-hover);
            box-shadow: var(--shadow-md);
        }

        .btn-send:active {
            transform: scale(0.98);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Toast confirmación */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--color-green-action);
            color: #FFFFFF;
            padding: 1rem 2rem;
            border-radius: var(--radius-md);
            font-weight: 700;
            z-index: 300;
            opacity: 0;
            transition: all 0.4s ease;
            box-shadow: var(--shadow-lg);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Mis órdenes */
        .my-orders-section {
            margin-top: 2.5rem;
        }

        .my-orders-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .order-card {
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .order-card:hover {
            border-color: var(--color-border);
            box-shadow: var(--shadow-md);
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .order-card-mesa {
            font-weight: 700;
            color: var(--color-primary);
            min-width: 0;
        }

        .order-card-total {
            font-weight: 700;
            color: var(--color-green-action);
        }

        .order-card-estado {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .order-card-platillos {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            margin-bottom: 0.5rem;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .estado-pendiente { background: var(--color-warning-light); color: var(--color-warning); border-radius: var(--radius-pill); border: 1px solid rgba(245,127,23,0.3); }
        .estado-preparacion { background: var(--color-primary-light); color: var(--color-primary); border-radius: var(--radius-pill); border: 1px solid rgba(21,101,192,0.3); }
        .estado-listo { background: var(--color-green-light); color: var(--color-green); border-radius: var(--radius-pill); border: 1px solid rgba(46,125,50,0.3); }
        .estado-entregado { background: var(--color-green-light); color: var(--color-green-action); border-radius: var(--radius-pill); border: 1px solid rgba(56,142,60,0.4); }

        .my-orders-empty {
            color: var(--color-text-muted);
            font-style: italic;
            padding: 1rem 0;
        }

        /* Header móvil: logo y nombre apilados; logout a la derecha */
        @media (max-width: 768px) {
            header {
                flex-wrap: nowrap;
                padding: 0.75rem 1rem;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                position: relative;
            }

            .logo {
                flex-shrink: 0;
            }

            .header-right {
                display: contents;
            }

            .waiter-name {
                font-size: 0.8rem;
                min-width: 0;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .btn-logout {
                position: absolute;
                right: 1rem;
                top: 50%;
                transform: translateY(-50%);
                min-height: 44px;
            }
            /* Feedback táctil: active en botones principales */
            .btn-logout,
            .btn-send,
            .btn-add,
            .modal-close,
            .table-btn {
                -webkit-tap-highlight-color: transparent;
            }
            .btn-logout:active,
            .btn-send:active,
            .btn-add:active,
            .modal-close:active,
            .table-btn:active {
                opacity: 0.7;
                transform: scale(0.98);
            }
        }

        /* Botones WhatsApp e Imprimir en mis órdenes */
        .order-card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            align-items: center;
        }
        .btn-whatsapp-mesero {
            padding: 8px 14px;
            font-size: 0.8rem;
            min-height: 44px;
            background: rgba(37, 211, 102, 0.2);
            color: #25d366;
            border: 1px solid #25d366;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .btn-whatsapp-mesero:hover {
            background: rgba(37, 211, 102, 0.35);
            color: #20bd5a;
        }
        .btn-print-mesero {
            padding: 8px 14px;
            font-size: 0.8rem;
            min-height: 44px;
            background: var(--color-card);
            color: var(--color-primary);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .btn-print-mesero:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        #ticket-container { display: none; }

        /* Impresión térmica 80mm: no ocultar #ticket-container */
        @media print {
            body > *:not(#ticket-container) { display: none !important; visibility: hidden !important; }
            #ticket-container {
                display: block !important;
                visibility: visible !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 80mm !important;
                min-width: 80mm !important;
                max-width: 80mm !important;
                margin: 0 !important;
                padding: 4mm !important;
                background: #fff !important;
                color: #000 !important;
                font-family: 'Courier New', Courier, monospace !important;
                font-size: 11px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            #ticket-container .ticket-paper { background: #fff !important; color: #000 !important; }
            #ticket-container .ticket-logo { font-size: 14px !important; font-weight: bold !important; text-align: center !important; margin: 0 0 6px !important; color: #000 !important; }
            #ticket-container .ticket-fecha,
            #ticket-container .ticket-detalles { text-align: center !important; margin: 4px 0 !important; font-size: 10px !important; color: #000 !important; }
            #ticket-container .ticket-tabla { width: 100% !important; border-collapse: collapse !important; margin: 6px 0 !important; font-size: 10px !important; }
            #ticket-container .ticket-tabla th,
            #ticket-container .ticket-tabla td { border: none !important; border-bottom: 1px dotted #000 !important; padding: 2px 4px !important; color: #000 !important; text-align: left !important; }
            #ticket-container .ticket-total { font-weight: bold !important; font-size: 12px !important; margin: 8px 0 4px !important; color: #000 !important; }
            #ticket-container .ticket-gracias { text-align: center !important; font-size: 10px !important; margin: 8px 0 0 !important; color: #000 !important; }
            @page { size: 80mm auto; margin: 0; }
            body { background: #fff !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        .btn-agregar-mas {
            padding: 8px 14px;
            font-size: 0.8rem;
            min-height: 44px;
            background: rgba(212, 175, 55, 0.15);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-agregar-mas:hover {
            background: rgba(212, 175, 55, 0.3);
        }

        .orden-platillo-fila {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #2a2a2a;
            font-size: 0.88rem;
        }
        .orden-platillo-fila:last-child {
            border-bottom: none;
        }
        .orden-platillo-nombre {
            flex: 1;
            color: var(--color-text);
        }
        .orden-platillo-qty {
            color: var(--color-primary);
            font-weight: 700;
            min-width: 28px;
            text-align: center;
        }
        .orden-platillo-precio {
            color: var(--color-text-muted);
            font-size: 0.8rem;
            min-width: 60px;
            text-align: right;
        }
        .btn-qty {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-qty.btn-qty-mas {
            background: #1565C0;
            color: #FFFFFF;
            border: none;
            transition: background 0.2s, transform 0.1s;
        }
        .btn-qty.btn-qty-mas:hover {
            background: #0D47A1;
        }
        .btn-qty.btn-qty-mas:active {
            transform: scale(0.95);
        }
        .btn-qty.btn-qty-menos {
            background: #FFFFFF;
            color: #1565C0;
            border: 2px solid #1565C0;
            transition: all 0.2s;
        }
        .btn-qty.btn-qty-menos:hover {
            background: #E3EEFF;
        }
        .btn-eliminar-platillo {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            border: 1.5px solid rgba(198,40,40,0.3);
            background: #FFEBEE;
            color: #C62828;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .btn-eliminar-platillo:hover {
            background: #C62828;
            color: #FFFFFF;
        }

        .orders-filter {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .orders-filter label {
            color: var(--color-text);
            font-weight: 700;
            font-size: 0.85rem;
        }
        .orders-filter input[type="date"] {
            padding: 8px 12px;
            background: #FFFFFF;
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text);
            font-size: 0.9rem;
            min-height: 44px;
            box-shadow: var(--shadow-xs);
        }
        .orders-filter input[type="date"]:focus {
            outline: none;
            border-color: var(--color-border-focus);
            box-shadow: 0 0 0 3px rgba(21,101,192,0.12);
        }
        .ordenes-count {
            color: var(--color-text-muted);
            font-size: 0.85rem;
        }
    </style>
</head>

<body>

    <header>
        <span class="logo">
            <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" width="26" height="26" style="display:inline-block;vertical-align:middle;">
                <ellipse cx="20" cy="26" rx="14" ry="10" fill="#8B0000"/>
                <rect x="5" y="17" width="30" height="5" rx="2.5" fill="#6B0000"/>
                <ellipse cx="20" cy="18" rx="14" ry="5" fill="#A00000"/>
                <rect x="17" y="12" width="6" height="6" rx="3" fill="#5D4037"/>
                <path d="M13,11 C12,9 14,7 13,4" fill="none" stroke="#E0E0E0" stroke-width="1.5" stroke-linecap="round"/>
                <path d="M20,11 C19,9 21,7 20,4" fill="none" stroke="#E0E0E0" stroke-width="1.5" stroke-linecap="round"/>
                <path d="M27,11 C26,9 28,7 27,4" fill="none" stroke="#E0E0E0" stroke-width="1.5" stroke-linecap="round"/>
                <path d="M6,22 C3,22 3,28 6,28" fill="none" stroke="#6B0000" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M34,22 C37,22 37,28 34,28" fill="none" stroke="#6B0000" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
            Familia González
        </span>
        <div class="header-right">
            <span class="waiter-name">Mesero: <strong id="waiterName">---</strong></span>
            <button type="button" class="btn-logout" id="btnLogout">Cerrar sesión</button>
        </div>
    </header>

    <main>
        <h2>Seleccione una mesa</h2>
        <div class="tables-grid" id="tablesGrid"></div>

        <section class="my-orders-section">
            <h2>Mis órdenes</h2>
            <div class="orders-filter">
                <label for="filtroFechaOrdenes">Fecha:</label>
                <input type="date" id="filtroFechaOrdenes">
                <span id="ordenesFechaCount" class="ordenes-count"></span>
            </div>
            <div class="my-orders-list" id="myOrdersList">
                <p class="my-orders-empty">Cargando...</p>
            </div>
        </section>
    </main>

    <!-- Modal pedido -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Mesa 1</h3>
                <button type="button" class="modal-close" id="modalClose" aria-label="Cerrar">&times;</button>
            </div>
            <div class="modal-body">
                <div class="menu-section">
                    <h3>Menú</h3>
                    <div class="menu-list" id="menuList"></div>
                </div>
                <div class="order-summary">
                    <h3>Resumen del pedido</h3>
                    <div class="order-items" id="orderItems">
                        <p class="empty-order">Sin artículos</p>
                    </div>
                    <div class="order-total">
                        <span>Total:</span>
                        <span id="orderTotal">$0</span>
                    </div>
                    <button type="button" class="btn-send" id="btnSend" disabled>Enviar Orden</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast confirmación -->
    <div class="toast" id="toast">Orden enviada correctamente</div>

    <div id="ticket-container" style="display:none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDKs (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <script src="ticket.js"></script>
    <script>
        (function () {
            'use strict';

            var selectedTable = null;
            var order = {};
            var tableButtons = {};
            var menuItems = [];
            var meseroNombre = '';
            var editandoOrdenId = null;
            var editandoPlatillosOriginales = [];

            // DOM
            var tablesGrid = document.getElementById('tablesGrid');
            var modalOverlay = document.getElementById('modalOverlay');
            var modalTitle = document.getElementById('modalTitle');
            var modalClose = document.getElementById('modalClose');
            var menuList = document.getElementById('menuList');
            var orderItems = document.getElementById('orderItems');
            var orderTotal = document.getElementById('orderTotal');
            var btnSend = document.getElementById('btnSend');
            var toast = document.getElementById('toast');
            var waiterNameEl = document.getElementById('waiterName');
            var btnLogout = document.getElementById('btnLogout');
            var myOrdersList = document.getElementById('myOrdersList');

            // Proteger página: si no hay usuario, ir a login
            auth.onAuthStateChanged(function (user) {
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                // 1. Obtener nombre del mesero desde usuarios/{uid}
                db.collection('usuarios').doc(user.uid).get().then(function (doc) {
                    if (doc.exists) {
                        var data = doc.data();
                        meseroNombre = data.nombre || data.displayName || user.displayName || user.email || 'Mesero';
                    } else {
                        meseroNombre = user.displayName || user.email || 'Mesero';
                    }
                    waiterNameEl.textContent = meseroNombre;
                }).catch(function () {
                    meseroNombre = user.displayName || user.email || 'Mesero';
                    waiterNameEl.textContent = meseroNombre;
                });

                // 2. Menú dinámico en tiempo real desde db.collection('menu')
                db.collection('menu').onSnapshot(function (snapshot) {
                    menuItems = [];
                    snapshot.forEach(function (doc) {
                        var d = doc.data();
                        menuItems.push({
                            id: doc.id,
                            name: d.nombre || d.name || 'Sin nombre',
                            price: typeof d.precio !== 'undefined' ? Number(d.precio) : (d.price ? Number(d.price) : 0),
                            categoria: d.categoria || 'Otros'
                        });
                    });
                    if (modalOverlay.classList.contains('open')) {
                        renderMenu();
                    }
                });

                // 4. Órdenes del mesero en tiempo real (con filtro de fecha)
                var todasOrdenesmesero = null;
                var filtroFechaInput = document.getElementById('filtroFechaOrdenes');
                var ordenesCountSpan = document.getElementById('ordenesFechaCount');
                if (filtroFechaInput) {
                    var hoy = new Date();
                    var yyyy = hoy.getFullYear();
                    var mm = String(hoy.getMonth() + 1).padStart(2, '0');
                    var dd = String(hoy.getDate()).padStart(2, '0');
                    filtroFechaInput.value = yyyy + '-' + mm + '-' + dd;
                }

                function filtrarYRenderOrdenes() {
                    var fechaStr = filtroFechaInput && filtroFechaInput.value ? filtroFechaInput.value.trim() : '';
                    if (!fechaStr && filtroFechaInput) {
                        var h = new Date();
                        fechaStr = h.getFullYear() + '-' + String(h.getMonth() + 1).padStart(2, '0') + '-' + String(h.getDate()).padStart(2, '0');
                    }
                    var inicio = new Date(fechaStr + 'T00:00:00.000');
                    var fin = new Date(fechaStr + 'T23:59:59.999');
                    var docs = todasOrdenesmesero && todasOrdenesmesero.docs ? todasOrdenesmesero.docs : [];
                    var filtrados = docs.filter(function (doc) {
                        var d = doc.data();
                        var ts = d.timestamp;
                        var fecha = ts && ts.toDate ? ts.toDate() : null;
                        if (fecha === null) return true;
                        return fecha >= inicio && fecha <= fin;
                    });

                    myOrdersList.innerHTML = '';
                    if (filtrados.length === 0) {
                        myOrdersList.innerHTML = '<p class="my-orders-empty">No hay órdenes para esta fecha.</p>';
                        if (ordenesCountSpan) ordenesCountSpan.textContent = '0 orden(es) encontrada(s)';
                        return;
                    }
                    if (ordenesCountSpan) ordenesCountSpan.textContent = filtrados.length + ' orden(es) encontrada(s)';

                    filtrados.forEach(function (doc) {
                        var o = doc.data();
                        var platillosArray = Array.isArray(o.platillos) ? o.platillos : [];
                        var estado = (o.estado || 'pendiente').toLowerCase().replace(/\s/g, '-');
                        var estadoClass = 'estado-pendiente';
                        if (estado === 'en-preparacion' || estado === 'preparacion') estadoClass = 'estado-preparacion';
                        else if (estado === 'listo' || estado === 'servido') estadoClass = 'estado-listo';
                        else if (estado === 'entregado') estadoClass = 'estado-entregado';
                        var esPagada = (o.estado || '').toLowerCase() === 'pagada';
                        var puedeCambiarQty = !esPagada && (estado === 'pendiente' || estado === 'en-preparacion' || estado === 'preparacion');
                        var puedeEliminar = !esPagada && estado === 'pendiente';

                        var platillosHtml = '';
                        platillosArray.forEach(function (p, idx) {
                            var cant = p.cantidad || 1;
                            var precio = p.precio || 0;
                            var subtotal = precio * cant;
                            var nombre = p.nombre || '';
                            platillosHtml += '<div class="orden-platillo-fila" data-index="' + idx + '">' +
                                '<span class="orden-platillo-nombre">' + nombre + '</span>' +
                                '<span class="orden-platillo-qty">[' + cant + 'x]</span>' +
                                '<span class="orden-platillo-precio">$' + precio + '</span>' +
                                '<span class="orden-platillo-precio">$' + subtotal.toFixed(2) + '</span>';
                            if (puedeCambiarQty) {
                                platillosHtml += '<button type="button" class="btn-qty btn-qty-mas" data-index="' + idx + '" aria-label="Aumentar">+</button>' +
                                    '<button type="button" class="btn-qty btn-qty-menos" data-index="' + idx + '" aria-label="Disminuir">−</button>';
                            }
                            if (puedeEliminar) {
                                platillosHtml += '<button type="button" class="btn-eliminar-platillo" data-index="' + idx + '" data-nombre="' + nombre.replace(/"/g, '&quot;') + '" aria-label="Eliminar">✕</button>';
                            }
                            platillosHtml += '</div>';
                        });
                        if (!platillosHtml) platillosHtml = '<div class="orden-platillo-fila"><span class="orden-platillo-nombre">—</span></div>';

                        var botonesAcciones = '';
                        if (!esPagada) {
                            botonesAcciones += '<button type="button" class="btn-agregar-mas" title="Agregar platillo">＋ Agregar platillo</button>';
                        }
                        botonesAcciones += '<button type="button" class="btn-whatsapp-mesero" title="Enviar por WhatsApp">WhatsApp</button>';
                        botonesAcciones += '<button type="button" class="btn-print-mesero" title="Imprimir ticket">Imprimir</button>';

                        var card = document.createElement('div');
                        card.className = 'order-card';
                        card.setAttribute('data-orden-id', doc.id);
                        card.innerHTML = '<div class="order-card-header">' +
                            '<span class="order-card-mesa">Mesa ' + (o.mesa || '—') + '</span>' +
                            '<span class="order-card-estado ' + estadoClass + '">' + (o.estado || 'pendiente') + '</span></div>' +
                            '<div class="order-card-platillos">' + platillosHtml + '</div>' +
                            '<div class="order-card-total">Total: $' + (typeof o.total === 'number' ? o.total.toFixed(2) : '0.00') + '</div>' +
                            '<div class="order-card-actions">' + botonesAcciones + '</div>';
                        myOrdersList.appendChild(card);

                        card.querySelector('.btn-whatsapp-mesero').addEventListener('click', function () {
                            if (typeof window.enviarWhatsApp === 'function') {
                                window.enviarWhatsApp(card.getAttribute('data-orden-id'));
                            }
                        });
                        var btnPrintMesero = card.querySelector('.btn-print-mesero');
                        if (btnPrintMesero) {
                            btnPrintMesero.addEventListener('click', function () {
                                if (typeof window.prepararTicket === 'function') {
                                    window.prepararTicket(card.getAttribute('data-orden-id'));
                                }
                            });
                        }

                        var btnAgregarMas = card.querySelector('.btn-agregar-mas');
                        if (btnAgregarMas) {
                            btnAgregarMas.addEventListener('click', function () {
                                var platillosActuales = platillosArray.slice();
                                var mesaNum = o.mesa || '?';
                                openModalEdicion(doc.id, mesaNum, platillosActuales);
                            });
                        }

                        card.querySelectorAll('.btn-qty-mas').forEach(function (btn) {
                            btn.addEventListener('click', function () {
                                var idx = parseInt(this.getAttribute('data-index'), 10);
                                var arr = platillosArray.slice();
                                if (idx < 0 || idx >= arr.length) return;
                                arr[idx] = {
                                    nombre: arr[idx].nombre,
                                    precio: arr[idx].precio || 0,
                                    cantidad: (arr[idx].cantidad || 1) + 1
                                };
                                var total = 0;
                                arr.forEach(function (p) { total += (p.precio || 0) * (p.cantidad || 1); });
                                db.collection('ordenes').doc(doc.id).update({ platillos: arr, total: total }).catch(function (err) {
                                    console.error('Error al actualizar:', err);
                                    alert('No se pudo actualizar la orden.');
                                });
                            });
                        });

                        card.querySelectorAll('.btn-qty-menos').forEach(function (btn) {
                            btn.addEventListener('click', function () {
                                var idx = parseInt(this.getAttribute('data-index'), 10);
                                var arr = platillosArray.slice();
                                if (idx < 0 || idx >= arr.length) return;
                                var cant = (arr[idx].cantidad || 1) - 1;
                                if (cant < 1) return;
                                arr[idx] = {
                                    nombre: arr[idx].nombre,
                                    precio: arr[idx].precio || 0,
                                    cantidad: cant
                                };
                                var total = 0;
                                arr.forEach(function (p) { total += (p.precio || 0) * (p.cantidad || 1); });
                                db.collection('ordenes').doc(doc.id).update({ platillos: arr, total: total }).catch(function (err) {
                                    console.error('Error al actualizar:', err);
                                    alert('No se pudo actualizar la orden.');
                                });
                            });
                        });

                        card.querySelectorAll('.btn-eliminar-platillo').forEach(function (btn) {
                            btn.addEventListener('click', function () {
                                var idx = parseInt(this.getAttribute('data-index'), 10);
                                var nombre = this.getAttribute('data-nombre') || 'este platillo';
                                if (!confirm('¿Eliminar ' + nombre + ' de la orden?')) return;
                                var arr = platillosArray.slice();
                                if (idx < 0 || idx >= arr.length) return;
                                arr.splice(idx, 1);
                                var total = 0;
                                arr.forEach(function (p) { total += (p.precio || 0) * (p.cantidad || 1); });
                                db.collection('ordenes').doc(doc.id).update({ platillos: arr, total: total }).catch(function (err) {
                                    console.error('Error al actualizar:', err);
                                    alert('No se pudo actualizar la orden.');
                                });
                            });
                        });
                    });
                }

                if (filtroFechaInput) {
                    filtroFechaInput.addEventListener('change', filtrarYRenderOrdenes);
                }

                db.collection('ordenes').where('meseroId', '==', user.uid).onSnapshot(function (snapshot) {
                    todasOrdenesmesero = snapshot;
                    filtrarYRenderOrdenes();
                });

                var lastOrdenesSnapshot = null;
                function actualizarGridMesas() {
                    if (!lastOrdenesSnapshot) return;
                    var docs = lastOrdenesSnapshot.docs || [];
                    var mesasPorEstado = {};
                    docs.forEach(function (doc) {
                        var o = doc.data();
                        var estado = (o.estado || '').toLowerCase();
                        if (estado !== 'pagada' && estado !== 'cancelada') {
                            var mesa = o.mesa;
                            var meseroId = o.meseroId || '';
                            if (mesa != null && mesa !== '') {
                                mesasPorEstado[mesa] = { meseroId: meseroId };
                            }
                        }
                    });
                    var currentUid = auth.currentUser ? auth.currentUser.uid : '';
                    for (var k in tableButtons) {
                        var btn = tableButtons[k];
                        btn.classList.remove('mesa-propia', 'mesa-ocupada-otro');
                        btn.removeAttribute('title');
                    }
                    for (var mesa in mesasPorEstado) {
                        var info = mesasPorEstado[mesa];
                        var btn = tableButtons[mesa];
                        if (!btn) continue;
                        if (info.meseroId === currentUid) {
                            btn.classList.add('mesa-propia');
                        } else {
                            btn.classList.add('mesa-ocupada-otro');
                            btn.setAttribute('title', 'Ocupada por otro mesero');
                        }
                    }
                }

                db.collection('ordenes').onSnapshot(function (snapshot) {
                    lastOrdenesSnapshot = snapshot;
                    actualizarGridMesas();
                });
            });

            // 5. Cerrar sesión
            btnLogout.addEventListener('click', function () {
                auth.signOut().then(function () {
                    window.location.href = 'login.html';
                });
            });

            // Cargar mesas desde configuración en Firestore en tiempo real (onSnapshot)
            function cargarMesas() {
                db.collection('configuracion').doc('mesas').onSnapshot(function (doc) {
                    tablesGrid.innerHTML = '';
                    for (var k in tableButtons) delete tableButtons[k];
                    var numeros = [];
                    if (doc.exists && doc.data().numeros && Array.isArray(doc.data().numeros) && doc.data().numeros.length > 0) {
                        numeros = doc.data().numeros;
                    } else {
                        for (var i = 1; i <= 50; i++) numeros.push(i);
                    }
                    numeros.forEach(function (numero) {
                        var btn = document.createElement('button');
                        btn.className = 'table-btn';
                        btn.textContent = 'Mesa ' + numero;
                        btn.setAttribute('data-table', numero);
                        btn.addEventListener('click', function () {
                            openModal(parseInt(this.getAttribute('data-table'), 10));
                        });
                        tablesGrid.appendChild(btn);
                        tableButtons[numero] = btn;
                    });
                    if (typeof actualizarGridMesas === 'function') actualizarGridMesas();
                }, function (err) {
                    console.error('Error cargando configuración de mesas:', err);
                    tablesGrid.innerHTML = '';
                    for (var k in tableButtons) delete tableButtons[k];
                    var numeros = [];
                    for (var d = 1; d <= 50; d++) numeros.push(d);
                    numeros.forEach(function (numero) {
                        var btn = document.createElement('button');
                        btn.className = 'table-btn';
                        btn.textContent = 'Mesa ' + numero;
                        btn.setAttribute('data-table', numero);
                        btn.addEventListener('click', function () {
                            openModal(parseInt(this.getAttribute('data-table'), 10));
                        });
                        tablesGrid.appendChild(btn);
                        tableButtons[numero] = btn;
                    });
                    if (typeof actualizarGridMesas === 'function') actualizarGridMesas();
                });
            }
            cargarMesas();

            // Renderizar menú (desde menuItems cargados por onSnapshot), agrupado por categoría
            function renderMenu() {
                var ordenCategorias = ['Entradas', 'Platos fuertes', 'Bebidas', 'Postres', 'Otros'];
                var byCat = {};
                menuItems.forEach(function (item) {
                    var c = item.categoria || 'Otros';
                    if (!byCat[c]) byCat[c] = [];
                    byCat[c].push(item);
                });
                menuList.innerHTML = '';
                ordenCategorias.forEach(function (cat) {
                    if (!byCat[cat] || byCat[cat].length === 0) return;
                    var section = document.createElement('div');
                    section.className = 'menu-section';
                    var h3 = document.createElement('h3');
                    h3.textContent = cat;
                    section.appendChild(h3);
                    byCat[cat].forEach(function (item) {
                        var div = document.createElement('div');
                        div.className = 'menu-item';
                        div.innerHTML = '<div class="menu-item-info">' +
                            '<span class="menu-item-name">' + item.name + '</span><br>' +
                            '<span class="menu-item-price">$' + item.price + '</span></div>' +
                            '<button type="button" class="btn-add" data-id="' + item.id + '" data-name="' + item.name + '" data-price="' + item.price + '">+</button>';
                        section.appendChild(div);
                    });
                    menuList.appendChild(section);
                });
                menuList.querySelectorAll('.btn-add').forEach(function (btn) {
                    btn.addEventListener('click', function () {
                        addItem(this.getAttribute('data-id'), this.getAttribute('data-name'), parseInt(this.getAttribute('data-price'), 10));
                    });
                });
            }

            function addItem(id, name, price) {
                if (!order[id]) {
                    order[id] = { name: name, price: price, qty: 0 };
                }
                order[id].qty++;
                updateOrderSummary();
            }

            function updateOrderSummary() {
                var total = 0;
                var html = '';
                for (var id in order) {
                    if (order[id].qty > 0) {
                        var subtotal = order[id].price * order[id].qty;
                        total += subtotal;
                        html += '<div class="order-item">' +
                            '<span><span class="order-item-qty">' + order[id].qty + 'x</span> ' + order[id].name + '</span>' +
                            '<span>$' + subtotal + '</span></div>';
                    }
                }
                if (html) {
                    orderItems.innerHTML = html;
                    btnSend.disabled = false;
                } else {
                    orderItems.innerHTML = '<p class="empty-order">Sin artículos</p>';
                    btnSend.disabled = true;
                }
                orderTotal.textContent = '$' + total;
            }

            function openModal(tableNum) {
                selectedTable = tableNum;
                order = {};
                modalTitle.textContent = 'Mesa ' + tableNum;
                renderMenu();
                updateOrderSummary();
                modalOverlay.classList.add('open');
                if (tableButtons[tableNum]) {
                    tableButtons[tableNum].classList.add('selected');
                }
            }

            function openModalEdicion(ordenId, mesaNum, platillosActuales) {
                editandoOrdenId = ordenId;
                editandoPlatillosOriginales = platillosActuales || [];
                selectedTable = mesaNum;
                order = {};
                modalTitle.textContent = 'Agregar a Mesa ' + mesaNum;
                btnSend.textContent = 'Agregar platillos';
                renderMenu();
                updateOrderSummary();
                modalOverlay.classList.add('open');
            }

            function closeModal() {
                modalOverlay.classList.remove('open');
                if (selectedTable && tableButtons[selectedTable]) {
                    tableButtons[selectedTable].classList.remove('selected');
                }
                selectedTable = null;
                order = {};
                editandoOrdenId = null;
                editandoPlatillosOriginales = [];
                btnSend.textContent = 'Enviar Orden';
                btnSend.disabled = true;
            }

            function showToast() {
                toast.classList.add('show');
                setTimeout(function () {
                    toast.classList.remove('show');
                }, 2500);
            }

            // 3. Enviar orden a db.collection('ordenes')
            function sendOrder() {
                if (Object.keys(order).length === 0) return;
                var user = auth.currentUser;
                if (!user) return;

                // Construir array de platillos nuevos seleccionados
                var platillosNuevos = [];
                var totalNuevo = 0;
                for (var id in order) {
                    if (order[id].qty > 0) {
                        platillosNuevos.push({
                            nombre: order[id].name,
                            precio: order[id].price,
                            cantidad: order[id].qty
                        });
                        totalNuevo += order[id].price * order[id].qty;
                    }
                }

                // MODO EDICIÓN: fusionar con platillos existentes y hacer update
                if (editandoOrdenId) {
                    var fusionados = editandoPlatillosOriginales.slice();
                    platillosNuevos.forEach(function(nuevo) {
                        var encontrado = false;
                        for (var i = 0; i < fusionados.length; i++) {
                            if (fusionados[i].nombre === nuevo.nombre) {
                                fusionados[i] = {
                                    nombre: fusionados[i].nombre,
                                    precio: fusionados[i].precio,
                                    cantidad: (fusionados[i].cantidad || 1) + nuevo.cantidad
                                };
                                encontrado = true;
                                break;
                            }
                        }
                        if (!encontrado) {
                            fusionados.push(nuevo);
                        }
                    });

                    // Recalcular total completo
                    var totalFinal = 0;
                    fusionados.forEach(function(p) {
                        totalFinal += (p.precio || 0) * (p.cantidad || 1);
                    });

                    db.collection('ordenes').doc(editandoOrdenId).update({
                        platillos: fusionados,
                        total: totalFinal
                    }).then(function() {
                        var toastEl = document.getElementById('toast');
                        toastEl.textContent = 'Platillos agregados correctamente';
                        toastEl.classList.add('show');
                        setTimeout(function() {
                            toastEl.classList.remove('show');
                            toastEl.textContent = 'Orden enviada correctamente';
                        }, 2500);
                        closeModal();
                    }).catch(function(err) {
                        console.error('Error al actualizar orden:', err);
                        alert('No se pudo actualizar la orden.');
                    });
                    return;
                }

                // MODO NUEVA ORDEN: flujo original
                if (!selectedTable) return;
                db.collection('ordenes').add({
                    mesa: String(selectedTable),
                    platillos: platillosNuevos,
                    total: totalNuevo,
                    estado: 'pendiente',
                    meseroId: user.uid,
                    meseroNombre: meseroNombre || user.displayName || user.email || 'Mesero',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(function() {
                    var toastEl = document.getElementById('toast');
                    toastEl.classList.add('show');
                    setTimeout(function() { toastEl.classList.remove('show'); }, 2500);
                    closeModal();
                }).catch(function(err) {
                    console.error('Error al guardar orden:', err);
                });
            }

            modalClose.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', function (e) {
                if (e.target === modalOverlay) closeModal();
            });
            btnSend.addEventListener('click', sendOrder);
        })();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(function (err) { console.warn('SW no registrado:', err); });
        }
    </script>
</body>

</html>
